import io
import streamlit as st
import plotly.express as px
import pandas as pd

from dashboard.data_loader import load


# =================================================
# HELPER: DERIVE SEVERITY FROM NMAP DATA
# =================================================
def derive_severity(row: pd.Series) -> str:
    """
    Derive vulnerability severity safely from Nmap output.
    This avoids relying on unavailable CVSS data.
    """
    vulns = row.get("vulnerabilities", 0)

    try:
        vulns = int(vulns)
    except Exception:
        vulns = 0

    if vulns >= 3:
        return "Critical"
    if vulns == 2:
        return "High"
    if vulns == 1:
        return "Medium"
    return "Low"


# =================================================
# PAGE ENTRYPOINT
# =================================================
def run(filters=None):
    """
    Vulnerability Insights Page

    ‚úî Uses ONLY Nmap (Layer-1) data
    ‚úî OpenVAS REMOVED permanently
    ‚úî Safe for empty / partial backend data
    """
    filters = filters or {}

    st.markdown(
        "<div class='section-title'>üêû Vulnerability Insights</div>",
        unsafe_allow_html=True
    )

    st.caption(
        "Vulnerability findings derived from Nmap service scans "
        "(Layer-1 ‚Üí Backend ‚Üí Dashboard)."
    )

    # =================================================
    # LOAD DATA FROM BACKEND
    # =================================================
    raw = load("/nmap/results")

    if raw is None:
        st.info("No scan results available. Run a scan to see vulnerabilities.")
        return

    if isinstance(raw, dict):
        st.info("Scan metadata received. No service-level data yet.")
        return

    if not isinstance(raw, pd.DataFrame) or raw.empty:
        st.info("No vulnerability data available from Nmap scans.")
        return

    df = raw.copy()
    df.columns = [c.lower() for c in df.columns]

    # =================================================
    # ENSURE REQUIRED COLUMNS
    # =================================================
    if "vulnerabilities" not in df.columns:
        df["vulnerabilities"] = 0

    if "severity" not in df.columns:
        df["severity"] = df.apply(derive_severity, axis=1)
    else:
        df["severity"] = df["severity"].astype(str).str.title()

    # =================================================
    # GLOBAL FILTERS (FROM DASHBOARD STATE)
    # =================================================
    view = df.copy()

    host_filter = filters.get("host")
    if host_filter and "host" in view.columns:
        view = view[view["host"].astype(str).str.contains(host_filter)]

    severity_filter = filters.get("severity")
    if severity_filter:
        view = view[view["severity"].isin(severity_filter)]

    # =================================================
    # INLINE PAGE FILTERS
    # =================================================
    st.markdown("### Filters")
    f1, f2 = st.columns([2, 2])

    host_text = f1.text_input(
        "Host contains",
        value=host_filter or "",
    )

    severity_options = ["Critical", "High", "Medium", "Low"]

    selected_sev = f2.multiselect(
        "Severity",
        options=severity_options,
        default=severity_filter or [],
    )

    if host_text and "host" in view.columns:
        view = view[view["host"].astype(str).str.contains(host_text)]

    if selected_sev:
        view = view[view["severity"].isin(selected_sev)]

    # =================================================
    # KPIs
    # =================================================
    total_findings = len(view)
    critical_count = int((view["severity"] == "Critical").sum())
    high_count = int((view["severity"] == "High").sum())

    k1, k2, k3 = st.columns(3)
    k1.metric("Total Findings", total_findings)
    k2.metric("Critical", critical_count)
    k3.metric("High", high_count)

    st.markdown("---")

    # =================================================
    # SEVERITY DISTRIBUTION
    # =================================================
    if not view.empty:
        sev_order = ["Critical", "High", "Medium", "Low"]

        sev_counts = (
            view["severity"]
            .value_counts()
            .reindex(sev_order)
            .fillna(0)
            .reset_index()
        )
        sev_counts.columns = ["severity", "count"]

        fig = px.bar(
            sev_counts,
            x="severity",
            y="count",
            title="Findings by Severity (Nmap-derived)",
            template=st.session_state.get("plotly_template", "plotly_dark"),
        )
        st.plotly_chart(fig, width='stretch')

    # =================================================
    # FINDINGS TABLE
    # =================================================
    st.markdown("### Finding Details")

    display_cols = [
        c for c in [
            "host",
            "port",
            "service",
            "product",
            "version",
            "severity",
            "vulnerabilities",
            "state",
            "scan_profile",
        ]
        if c in view.columns
    ]

    st.dataframe(
        view[display_cols],
        width='stretch',
        hide_index=True,
    )

    # =================================================
    # EXPORT
    # =================================================
    st.markdown("### Export")

    try:
        buf = io.StringIO()
        view.to_csv(buf, index=False)

        st.download_button(
            "Download Findings CSV",
            buf.getvalue(),
            file_name="nmap_vulnerability_insights.csv",
            mime="text/csv",
        )
    except Exception:
        st.warning("Unable to prepare CSV export.")
